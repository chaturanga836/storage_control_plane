# Makefile for Storage Control Plane

.PHONY: test test-unit test-integration test-e2e build run clean help setup install-tools dev-linux

# Default target
help:
	@echo "Available commands:"
	@echo "  make test          - Run unit + integration tests"
	@echo "  make test-unit     - Run unit tests (fast, no dependencies)"
	@echo "  make test-integration - Run integration tests (requires services)"
	@echo "  make test-e2e      - Run end-to-end tests"
	@echo "  make test-all      - Run all tests including E2E"
	@echo "  make build         - Build the application"
	@echo "  make run           - Run the application"
	@echo "  make clean         - Clean build artifacts"
	@echo "  make dev           - Run with hot reload (air)"
	@echo "  make dev-linux     - Linux development setup"
	@echo "  make setup         - Setup development environment"
	@echo "  make install-tools - Install development tools"

# Build the application
build:
	@echo "🔨 Building Storage Control Plane..."
	@mkdir -p bin
	go build -o bin/storage-control-plane ./cmd/api

# Build for multiple platforms
build-all:
	@echo "🔨 Building for multiple platforms..."
	@mkdir -p bin
	GOOS=linux GOARCH=amd64 go build -o bin/storage-control-plane-linux-amd64 ./cmd/api
	GOOS=windows GOARCH=amd64 go build -o bin/storage-control-plane-windows-amd64.exe ./cmd/api
	GOOS=darwin GOARCH=amd64 go build -o bin/storage-control-plane-darwin-amd64 ./cmd/api
	GOOS=darwin GOARCH=arm64 go build -o bin/storage-control-plane-darwin-arm64 ./cmd/api
	@echo "✅ Built for Linux, Windows, macOS (Intel & Apple Silicon)"

# Run unit tests (fast, no external dependencies)
test-unit:
	@echo "🧪 Running unit tests..."
	go test -v ./test/unit/...

# Run integration tests (requires external services)
test-integration:
	@echo "🔗 Running integration tests..."
	@echo "⚠️  Make sure ClickHouse and other services are running"
	go test -v ./test/integration/...

# Run end-to-end tests
test-e2e:
	@echo "🚀 Running end-to-end tests..."
ifeq ($(OS),Windows_NT)
	powershell -ExecutionPolicy Bypass -File ./test/e2e/test_e2e.ps1
else
	./test/e2e/test_e2e.sh
endif

# Run all tests
test: test-unit test-integration
	@echo "✅ All tests completed"

# Run all tests including E2E
test-all: test-unit test-integration test-e2e
	@echo "🎉 All tests (including E2E) completed"

# Run end-to-end tests (requires running server)
test-e2e:
	@echo "🌐 Running end-to-end tests..."
	@echo "⚠️  Make sure the server is running on :8081"
	@if command -v pwsh &> /dev/null; then \
		pwsh -File test_e2e.ps1; \
	elif [ -f "test_e2e.sh" ]; then \
		chmod +x test_e2e.sh && ./test_e2e.sh; \
	else \
		echo "❌ No E2E test script found"; \
	fi

# Linux/Unix development workflow
dev-linux:
	@echo "🐧 Setting up Linux development environment..."
	@if [ -f "dev.sh" ]; then \
		chmod +x dev.sh && ./dev.sh; \
	else \
		echo "❌ dev.sh not found"; \
	fi

# Setup development environment
setup:
	@echo "🔧 Setting up development environment..."
	@mkdir -p data/rocksdb data/parquet data/wal tmp bin
	@if [ ! -f ".env" ]; then \
		cp .env.example .env; \
		echo "📄 Created .env from .env.example"; \
	fi
	go mod download
	@echo "✅ Development environment ready"

# Install development tools
install-tools:
	@echo "🛠️  Installing development tools..."
	go install github.com/cosmtrek/air@latest
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install github.com/securecodewarrior/sast-scan@latest
	go install golang.org/x/tools/cmd/pprof@latest

# Performance and optimization targets
benchmark:
	@echo "⚡ Running performance benchmarks..."
	go test -bench=. -benchmem ./test/performance/...

profile-cpu:
	@echo "🔍 Profiling CPU usage..."
	go test -cpuprofile=cpu.prof -bench=. ./test/performance/...
	go tool pprof cpu.prof

profile-memory:
	@echo "🧠 Profiling memory usage..."
	go test -memprofile=mem.prof -bench=. ./test/performance/...
	go tool pprof mem.prof

optimize:
	@echo "🚀 Running optimization analysis..."
	go test -bench=. -benchmem -cpuprofile=cpu.prof -memprofile=mem.prof ./test/performance/...
	@echo "💡 Check cpu.prof and mem.prof for optimization opportunities"

# Security scanning
security-scan:
	@echo "🔒 Running security scans..."
	golangci-lint run --enable=gosec,gocritic ./...
	@echo "⚠️  Consider running: go list -json -m all | nancy sleuth"

# Load testing
load-test:
	@echo "💪 Running load tests..."
	@if command -v hey >/dev/null 2>&1; then \
		hey -n 1000 -c 10 http://localhost:8081/health; \
	else \
		echo "Install 'hey' for load testing: go install github.com/rakyll/hey@latest"; \
	fi

stress-test:
	@echo "😤 Running stress tests..."
	@if command -v hey >/dev/null 2>&1; then \
		hey -n 10000 -c 100 -t 30 http://localhost:8081/health; \
	else \
		echo "Install 'hey' for stress testing: go install github.com/rakyll/hey@latest"; \
	fi

# Production readiness checks
prod-check:
	@echo "🔍 Running production readiness checks..."
	@echo "📊 Checking binary size..."
	@ls -lh bin/ || echo "No binaries found - run 'make build' first"
	@echo "🔒 Security scan..."
	@golangci-lint run --enable=gosec || echo "Install golangci-lint for security scanning"
	@echo "🧪 Test coverage..."
	@go test -cover ./... || echo "Some tests failed"
	@echo "✅ Production checks complete"

# Docker support
docker-build:
	@echo "🐳 Building Docker image..."
	docker build -t storage-control-plane:latest .

docker-run:
	@echo "🚀 Running Docker container..."
	docker run -p 8081:8081 storage-control-plane:latest

# Clean all artifacts
clean-all: clean
	@echo "🧹 Deep cleaning..."
	@rm -rf bin/ tmp/ *.prof *.test
	@docker system prune -f || echo "Docker not available"
	@echo "✨ All clean!"
	go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest
	go install golang.org/x/tools/cmd/goimports@latest
	@echo "✅ Development tools installed"

# Run the application
run:
	@echo "🚀 Starting Storage Control Plane..."
	go run ./cmd/api

# Run with hot reload
dev:
	@echo "🔥 Starting with hot reload..."
	air

# Clean build artifacts and test data
clean:
	@echo "🧹 Cleaning up..."
	rm -rf bin/
	rm -rf tmp/
	rm -rf test_data/
	rm -f *.log
	rm -f coverage.out coverage.html
	go clean -cache -testcache

# Setup test environment
setup-test:
	@echo "🔧 Setting up test environment..."
	mkdir -p test_data/rocksdb
	mkdir -p test_data/parquet
	cp .env.test .env

# Performance tests
test-perf:
	@echo "⚡ Running performance tests..."
	go test -bench=. -benchmem ./internal/...

# Coverage report
test-coverage:
	@echo "📊 Generating coverage report..."
	go test -coverprofile=coverage.out ./internal/... ./pkg/...
	go tool cover -html=coverage.out -o coverage.html
	@echo "📋 Coverage report generated: coverage.html"

# Lint code
lint:
	@echo "🔍 Linting code..."
	@if command -v golangci-lint &> /dev/null; then \
		golangci-lint run; \
	else \
		echo "⚠️  golangci-lint not installed. Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"; \
	fi

# Format code
fmt:
	@echo "💅 Formatting code..."
	go fmt ./...
	goimports -w .

# Check for security issues
security:
	@echo "🔒 Checking for security issues..."
	@if command -v gosec &> /dev/null; then \
		gosec ./...; \
	else \
		echo "⚠️  gosec not installed. Install with: go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest"; \
	fi

# Performance and optimization targets
.PHONY: benchmark profile optimize

benchmark: ## Run performance benchmarks
	@echo "🚀 Running performance benchmarks..."
	go test -bench=. -benchmem ./test/unit/... ./internal/...

profile: ## Generate CPU and memory profiles
	@echo "📊 Generating performance profiles..."
	go test -cpuprofile=cpu.prof -memprofile=mem.prof -bench=. ./test/unit/...
	@echo "🔍 To analyze profiles, run:"
	@echo "  go tool pprof cpu.prof"
	@echo "  go tool pprof mem.prof"

optimize: ## Run optimization checks
	@echo "⚡ Running optimization checks..."
	@echo "🔍 Checking for exhaustive switch statements..."
	@if command -v exhaustive &> /dev/null; then \
		exhaustive ./...; \
	else \
		echo "⚠️  Installing exhaustive..."; \
		go install github.com/nishanths/exhaustive/cmd/exhaustive@latest; \
		exhaustive ./...; \
	fi
	@echo "🔍 Checking for unnecessary type conversions..."
	@if command -v unconvert &> /dev/null; then \
		unconvert ./...; \
	else \
		echo "⚠️  Installing unconvert..."; \
		go install github.com/mdempsky/unconvert@latest; \
		unconvert ./...; \
	fi
	@echo "🔍 Checking for ineffective assignments..."
	@if command -v ineffassign &> /dev/null; then \
		ineffassign ./...; \
	else \
		echo "⚠️  Installing ineffassign..."; \
		go install github.com/gordonklaus/ineffassign@latest; \
		ineffassign ./...; \
	fi

# Enhanced security targets  
.PHONY: security-scan vulnerability-check

security-scan: ## Run comprehensive security analysis
	@echo "🔒 Running comprehensive security analysis..."
	@echo "🛡️  Running gosec scanner..."
	@if command -v gosec &> /dev/null; then \
		gosec -fmt json -out gosec-report.json ./...; \
		gosec ./...; \
	else \
		echo "⚠️  Installing gosec..."; \
		go install github.com/securecodewarrior/gosec/v2/cmd/gosec@latest; \
		gosec ./...; \
	fi
	@echo "🔍 Verifying module dependencies..."
	go mod verify

vulnerability-check: ## Check for known vulnerabilities
	@echo "🛡️ Checking for known vulnerabilities..."
	@if command -v govulncheck &> /dev/null; then \
		govulncheck ./...; \
	else \
		echo "⚠️  Installing govulncheck..."; \
		go install golang.org/x/vuln/cmd/govulncheck@latest; \
		govulncheck ./...; \
	fi

# Load testing targets
.PHONY: load-test stress-test

load-test: ## Run load tests against the API
	@echo "📊 Running load tests..."
	@if command -v wrk &> /dev/null; then \
		echo "🚀 Testing with wrk..."; \
		wrk -t12 -c400 -d30s --script=test/load/api_test.lua http://localhost:8081/health; \
	elif command -v ab &> /dev/null; then \
		echo "🚀 Testing with Apache Bench..."; \
		ab -n 10000 -c 100 http://localhost:8081/health; \
	else \
		echo "⚠️  No load testing tool found. Install wrk or apache2-utils"; \
	fi

stress-test: ## Run stress tests to find breaking points
	@echo "💥 Running stress tests..."
	@echo "⚠️  This will push the system to its limits"
	@if command -v wrk &> /dev/null; then \
		echo "🔥 Running high-concurrency test..."; \
		wrk -t20 -c1000 -d60s http://localhost:8081/health; \
	else \
		echo "⚠️  wrk not found. Install with: apt-get install wrk"; \
	fi

# Production readiness checks
.PHONY: production-check deploy-check

production-check: lint security-scan vulnerability-check optimize ## Run all production readiness checks
	@echo "🚀 Running production readiness checks..."
	@echo "✅ Code quality checks completed"
	@echo "✅ Security analysis completed"  
	@echo "✅ Vulnerability scan completed"
	@echo "✅ Optimization checks completed"
	@echo "🎉 System is production-ready!"

deploy-check: test-all production-check ## Full deployment verification
	@echo "🚀 Running complete deployment checks..."
	@echo "✅ All tests passed"
	@echo "✅ Production checks passed"
	@echo "🎉 Ready for deployment!"
